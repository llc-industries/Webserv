# SERVEUR 1 : Le serveur principal avec toutes les fonctionnalités
server {
    # [cite: 91] Port et Host d'écoute
    listen 8080;
    host 127.0.0.1;

    # [cite: 107] Nom du serveur (utile si tu gères les Virtual Hosts)
    server_name webserv.com;

    # [cite: 92] Pages d'erreur par défaut
    # Si le serveur déclenche une 404 ou 500, il sert ces fichiers
    error_page 404 /errors/404.html;
    error_page 500 502 503 504 /errors/50x.html;

    # [cite: 92] Limite de taille du body client (pour éviter les DoS via POST)
    # Ici : 1 Méga-octet
    client_max_body_size 1048576;

    # [cite: 94] Racine globale (si non spécifiée dans une location)
    root /var/www/html;

    # [cite: 95] Fichier par défaut si le chemin est un dossier
    index index.html index.htm;

    # --- ROUTE 1 : La racine standard ---
    location / {
        # [cite: 93] Méthodes HTTP acceptées
        allow_methods GET POST;

        # [cite: 95] Autoindex (listing des fichiers) désactivé
        autoindex off;
    }

    # --- ROUTE 2 : Upload de fichiers ---
    location /upload {
        allow_methods POST;

        # [cite: 96] Dossier où les fichiers uploadés seront stockés
        upload_store /var/www/html/uploads;
    }

    # --- ROUTE 3 : Dossier avec listing activé ---
    location /tours {
        allow_methods GET;
        root /var/www/html/tours;

        # [cite: 95] Si pas d'index, on affiche la liste des fichiers
        autoindex on;
    }

    # --- ROUTE 4 : Redirection HTTP ---
    location /old-page {
        # [cite: 94] Code 301 (Moved Permanently) vers une autre URL
        return 301 http://127.0.0.1:8080/new-page;
    }

    # --- ROUTE 5 : Execution CGI (PHP) ---
    # [cite: 97] Basé sur l'extension .php
    location *.php {
        allow_methods GET POST;

        # [cite: 97] Le chemin vers l'interpréteur CGI
        cgi_pass /usr/bin/php-cgi;
    }

    # --- ROUTE 6 : Execution CGI (Python) ---
    location *.py {
        allow_methods GET POST;
        cgi_pass /usr/bin/python3;
    }
}

# SERVEUR 2 : Un second serveur sur un port différent
# Pour tester le multiplexage de plusieurs ports [cite: 83]
server {
    listen 9090;
    host 127.0.0.1;
    server_name admin.webserv.com;

    client_max_body_size 100; # Très restrictif

    location / {
        allow_methods GET DELETE; # DELETE autorisé ici
        root /var/www/admin;
        index admin.html;
    }
}
